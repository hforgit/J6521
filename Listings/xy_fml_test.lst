C51 COMPILER V9.01   XY_FML_TEST                                                           03/27/2021 10:41:03 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE XY_FML_TEST
OBJECT MODULE PLACED IN .\Objects\xy_fml_test.obj
COMPILER INVOKED BY: D:\MDK5\C51\BIN\C51.EXE 02_FML\xy_fml_test.c LARGE OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\01_APL;.\
                    -02_FML;.\03_HAL;.\04_SYS) DEBUG PRINT(.\Listings\xy_fml_test.lst) OBJECT(.\Objects\xy_fml_test.obj)

line level    source

   1          #include "xy_sys_headfile.h"
   2          
   3          static unsigned char  errcod;
   4          
   5          /*********************************************************************************************************
             -**************
   6          * Function Name: 
   7          * Description  : 
   8          * Arguments    : None
   9          * Return Value : None
  10          **********************************************************************************************************
             -*************/
  11          void fml_test_old_dis(unsigned char* table)
  12          {
  13   1              static unsigned char s_bit = 0; 
  14   1      
  15   1              table[0] = 0x68;
  16   1              table[1] = 0x02;
  17   1              switch(errcod)
  18   1              {
  19   2                      case 0:
  20   2                              if(s_bit == 0)
  21   2                              {
  22   3                                      table[2] = 0x07;
  23   3                                      table[3] = 0x7F;
  24   3                              }
  25   2                              else
  26   2                              {
  27   3                                      table[2] = s_bit <  4 ? 0x01 << (s_bit-1) : 0x00;
  28   3                                      table[3] = s_bit >= 4 ? 0x01 << (s_bit-4) : 0x00;
  29   3                              }
  30   2                              s_bit++;
  31   2                              if(s_bit > 10)
  32   2                                      s_bit = 0;
  33   2                              break;
  34   2                      case 1:
  35   2                              table[2] = 0x00;
  36   2                              table[3] = 0x5C;
  37   2                              break;
  38   2                      case 2:
  39   2                              table[2] = 0x00;
  40   2                              table[3] = 0x7C;
  41   2                              break;
  42   2                      case 3:
  43   2                              table[2] = 0x00;
  44   2                              table[3] = 0x58;
  45   2                              break;
  46   2                      case 4:
  47   2                              table[2] = 0x07;
  48   2                              table[3] = 0x7F;
  49   2                              s_bit = 0;
  50   2                              break;
  51   2                      default:
  52   2                              table[2] = 0x00;
C51 COMPILER V9.01   XY_FML_TEST                                                           03/27/2021 10:41:03 PAGE 2   

  53   2                              table[3] = 0x00;
  54   2                              break;
  55   2              }
  56   1              table[4] = table[0] + table[1] + table[2] + table[3];
  57   1              table[5] = 0x16;        
  58   1      }
  59          
  60          /*********************************************************************************************************
             -**************
  61          * Function Name: 
  62          * Description  : 
  63          * Arguments    : None
  64          * Return Value : None
  65          **********************************************************************************************************
             -*************/
  66          void fml_test_uart(unsigned char mode)
  67          {
  68   1              static unsigned char s_table[16] = {0};
  69   1      
  70   1              switch(mode)
  71   1              {
  72   2                      case 0:                         ///< old protocol
  73   2                              fml_test_old_dis(s_table);
  74   2                      
  75   2                              hal_serial_uart_tx_display(s_table, 6);
  76   2                              break;
  77   2                      default:
  78   2                              break;
  79   2              }
  80   1      }
  81          
  82          /*********************************************************************************************************
             -**************
  83          * Function Name: 
  84          * Description  : 
  85          * Arguments    : None
  86          * Return Value : None
  87          **********************************************************************************************************
             -*************/
  88          void fml_test_delay(void)
  89          {
  90   1              unsigned int i, j;
  91   1      
  92   1              watchdog();
  93   1              for(i=0; i<200; i++)
  94   1              {       
  95   2                      for(j=0; j<1000; j++)
  96   2                      {
  97   3                              ;
  98   3                      }
  99   2              }
 100   1              watchdog();
 101   1              fml_test_uart(errcod);  
 102   1              for(i=0; i<200; i++)
 103   1              {
 104   2                      for(j=0; j<1000; j++)
 105   2                      {
 106   3                              ;
 107   3                      }
 108   2              }       
 109   1              watchdog();
 110   1      }
C51 COMPILER V9.01   XY_FML_TEST                                                           03/27/2021 10:41:03 PAGE 3   

 111          
 112          /*********************************************************************************************************
             -**************
 113          * Function Name: 
 114          * Description  : 
 115          * Arguments    : None
 116          * Return Value : None
 117          **********************************************************************************************************
             -*************/
 118          void fml_test_port(void)
 119          {
 120   1              /*1*/
 121   1              #ifdef TEST_FUNC_NUMB_01
 122   1              PTC_on();
 123   1              fml_test_delay();
 124   1              PTC_off();
 125   1              #endif
 126   1      
 127   1              /*2*/
 128   1              #ifdef TEST_FUNC_NUMB_02
 129   1              rav_on();
 130   1              fml_test_delay();
 131   1              rav_off();
 132   1              #endif
 133   1      
 134   1              /*4*/
 135   1              #ifdef TEST_FUNC_NUMB_04
 136   1              blow_fan_on();
 137   1              fml_test_delay();
 138   1              blow_fan_off();
 139   1              #endif
 140   1      
 141   1              /*5*/
 142   1              #ifdef TEST_FUNC_NUMB_05
 143   1              light_on();
 144   1              fml_test_delay();
 145   1              light_off();
 146   1              #endif
 147   1              
 148   1      }
 149          
 150          /*********************************************************************************************************
             -**************
 151          * Function Name: 
 152          * Description  : 
 153          * Arguments    : None
 154          * Return Value : None
 155          **********************************************************************************************************
             -*************/
 156          void fml_test_motor(void)
 157          {
 158   1              /*6*/
 159   1              #ifdef TEST_FUNC_NUMB_06
 160   1              blow_motor_step4_on();
 161   1              fml_test_delay();
 162   1              blow_motor_step4_off();
 163   1              #endif
 164   1              
 165   1              /*7*/
 166   1              #ifdef TEST_FUNC_NUMB_07
 167   1              blow_motor_step3_on();
 168   1              fml_test_delay();
C51 COMPILER V9.01   XY_FML_TEST                                                           03/27/2021 10:41:03 PAGE 4   

 169   1              blow_motor_step3_off();
 170   1              #endif
 171   1              
 172   1              /*8*/
 173   1              #ifdef TEST_FUNC_NUMB_08
 174   1              blow_motor_step2_on();
 175   1              fml_test_delay();
 176   1              blow_motor_step2_off();
 177   1              #endif
 178   1      
 179   1              /*9*/
 180   1              #ifdef TEST_FUNC_NUMB_09
 181   1              blow_motor_step1_on();
 182   1              fml_test_delay();
 183   1              blow_motor_step1_off();
 184   1              #endif
 185   1              fml_test_delay();
 186   1              fml_test_delay();
 187   1              fml_test_delay();
 188   1      }
 189          
 190          /*********************************************************************************************************
             -**************
 191          * Function Name: 
 192          * Description  : 
 193          * Arguments    : None
 194          * Return Value : None
 195          **********************************************************************************************************
             -*************/
 196          void fml_test_temp(datall* p_data)
 197          {
 198   1              unsigned int timeout = 0;
 199   1              
 200   1              while(1)
 201   1              {
 202   2                      if(p_data->uart.rec_uart1_ok)
 203   2                      {
 204   3                              break;
 205   3                      }
 206   2                      timeout++;
 207   2                      if(timeout >= 60000)
 208   2                      {
 209   3                              timeout = 60000;
 210   3                      }
 211   2                      watchdog();
 212   2              }
 213   1              if(p_data->temperature.value == 0)                      ///< short circuit
 214   1              {
 215   2                      errcod = 1;
 216   2              }
 217   1              else if(p_data->temperature.value > 80)         ///< cut circuit
 218   1              {
 219   2                      errcod = 2;
 220   2              }
 221   1              else if(timeout == 60000)                                       ///< lost uart from display
 222   1              {
 223   2                      errcod = 3;
 224   2              }
 225   1              else
 226   1              {
 227   2                      errcod = 0;
 228   2              }
C51 COMPILER V9.01   XY_FML_TEST                                                           03/27/2021 10:41:03 PAGE 5   

 229   1      }
 230          
 231          /*********************************************************************************************************
             -**************
 232          * Function Name: 
 233          * Description  : 
 234          * Arguments    : None
 235          * Return Value : None
 236          **********************************************************************************************************
             -*************/
 237          void fml_test_init(void)
 238          {       
 239   1              blow_fan_off();
 240   1              light_off();    
 241   1              rav_off();
 242   1              PTC_off();
 243   1      
 244   1              blow_motor_step1_off();
 245   1              blow_motor_step2_off();
 246   1              blow_motor_step3_off();
 247   1              blow_motor_step4_off();
 248   1      }
 249          
 250          /*********************************************************************************************************
             -**************
 251          * Function Name: 
 252          * Description  : 
 253          * Arguments    : None
 254          * Return Value : None
 255          **********************************************************************************************************
             -*************/
 256          switchstate fml_test_check(void) 
 257          {
 258   1              static unsigned char s_count = 0;
 259   1              
 260   1              if(self_test() == 0)
 261   1              {
 262   2                      s_count++;
 263   2                      if(s_count > 2)
 264   2                      {
 265   3                              fml_test_init();
 266   3                              return YES;
 267   3                      }
 268   2              }
 269   1              else
 270   1              {
 271   2                      s_count = 0;
 272   2              }
 273   1              return NO;
 274   1      }
 275          
 276          /*********************************************************************************************************
             -**************
 277          * Function Name: 
 278          * Description  : 
 279          * Arguments    : None
 280          * Return Value : None
 281          **********************************************************************************************************
             -*************/
 282          void fml_test_logic(datall* p_data)
 283          {
 284   1              static unsigned char s_step = 0;
C51 COMPILER V9.01   XY_FML_TEST                                                           03/27/2021 10:41:03 PAGE 6   

 285   1      
 286   1              if(YES == p_data->testmode)
 287   1              {
 288   2                      watchdog();
 289   2                      switch(s_step)
 290   2                      {
 291   3                              case 0:
 292   3                                      s_step++;
 293   3                                      p_data->buzzer.burn_bee_on = ON;        
 294   3                                      fml_test_uart(0);
 295   3                                      fml_test_temp(p_data);
 296   3                                      break;
 297   3                              case 1:
 298   3                                      if(OFF == p_data->buzzer.burn_bee_on)   ///< start test beep
 299   3                                      {
 300   4                                              fml_test_port();
 301   4                                              fml_test_motor();
 302   4                                              s_step = 0;
 303   4                                      }
 304   3                                      break;
 305   3                              default:
 306   3                                      break;
 307   3                      }
 308   2              }       
 309   1      }
 310          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    801    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     20      10
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
